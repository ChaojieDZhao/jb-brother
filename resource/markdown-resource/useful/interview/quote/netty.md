为什么会发生 TCP 粘包、拆包

应用程序写入的数据大于套接字缓冲区大小，这将会发生拆包。

应用程序写入数据小于套接字缓冲区大小，网卡将应用多次写入的数据发送到网络上，这将会发生粘包。

进行 MSS （最大报文长度）大小的 TCP 分段，当 TCP 报文长度-TCP 头部长度>MSS 的时候将发生拆包。

接收方法不及时读取套接字缓冲区数据，这将发生粘包。



何处理粘包、拆包

通常会有以下一些常用的方法：

使用带消息头的协议、消息头存储消息开始标识及消息长度信息，服务端获取消息头的时候解析出消息长度，然后向后读取该长度的内容。

设置定长消息，服务端每次读取既定长度的内容作为一条完整消息，当消息不够长时，空位补上固定字符。

设置消息边界，服务端从网络流中按消息编辑分离出消息内容，一般使用‘\n ’。

更为复杂的协议，例如楼主最近接触比较多的车联网协议 808,809 协议。


LineBasedFrameDecoder 回车换行解码器
DelimiterBasedFrameDecoder（添加特殊分隔符报文来分包） 分隔符解码器
FixedLengthFrameDecoder（使用定长的报文来分包） 固定长度解码器
LengthFieldBasedFrameDecoder 大多数的协议（私有或者公有），协议头中会携带长度字段，用于标识消息体或者整包消息的长度，例如SMPP、HTTP协议等。